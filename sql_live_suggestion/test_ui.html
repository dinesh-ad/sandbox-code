<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Live Suggestion</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: #1a1a2e;
            color: #eee;
            padding: 40px;
            max-width: 700px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00d9ff;
            margin-bottom: 30px;
        }
        
        .env-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }
        
        .env-btn {
            flex: 1;
            padding: 14px;
            border: 2px solid #0f3460;
            border-radius: 8px;
            background: transparent;
            color: #888;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .env-btn:hover {
            border-color: #00d9ff;
            color: #00d9ff;
        }
        
        .env-btn.active {
            background: #00d9ff;
            color: #1a1a2e;
            border-color: #00d9ff;
        }
        
        .search-box {
            background: #16213e;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #0f3460;
        }
        
        .search-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .scope-select {
            width: 130px;
        }
        
        .search-input-wrap {
            flex: 1;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            color: #888;
            font-size: 13px;
        }
        
        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #0f3460;
            border-radius: 8px;
            background: #1a1a2e;
            color: #fff;
            font-size: 15px;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #00d9ff;
        }
        
        .config-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .config-row > div {
            flex: 1;
        }
        
        .config-row input {
            padding: 10px;
            font-size: 14px;
        }
        
        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #0f3460;
            border-radius: 8px;
            margin-top: 4px;
            z-index: 10;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #16213e;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background: #1a1a2e;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-name {
            color: #00d9ff;
            font-family: monospace;
            font-size: 14px;
        }
        
        .suggestion-score {
            color: #666;
            font-size: 12px;
            background: #1a1a2e;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .status-msg {
            margin-top: 12px;
            font-size: 13px;
            color: #888;
            min-height: 20px;
        }
        
        .result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 8px;
            display: none;
        }
        
        .result.show {
            display: block;
        }
        
        .result.valid {
            background: #0a3622;
            border: 1px solid #22c55e;
        }
        
        .result.suggestions {
            background: #3d2e0a;
            border: 1px solid #eab308;
        }
        
        .result.not_found {
            background: #3b0f0f;
            border: 1px solid #ef4444;
        }
        
        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.valid { background: #22c55e; color: #000; }
        .status-badge.suggestions { background: #eab308; color: #000; }
        .status-badge.not_found { background: #ef4444; color: #fff; }
        
        .result-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .result-text code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .suggestion-list {
            margin-top: 8px;
            padding-left: 20px;
        }
        
        .suggestion-list li {
            margin: 4px 0;
            font-family: monospace;
            color: #00d9ff;
        }
        
        .action-text {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
        }
        
        .action-text.go { color: #22c55e; }
        .action-text.block { color: #ef4444; }
    </style>
</head>
<body>
    <h1>SQL Live Suggestion</h1>

    <!-- Environment Selection -->
    <div class="env-buttons">
        <button class="env-btn active" onclick="selectEnv('dev')">DEV</button>
        <button class="env-btn" onclick="selectEnv('qa')">QA</button>
        <button class="env-btn" onclick="selectEnv('stage')">STAGE</button>
        <button class="env-btn" onclick="selectEnv('prod')">PROD</button>
    </div>

    <!-- Search Box -->
    <div class="search-box">
        <div class="search-row">
            <div class="scope-select">
                <label>Scope</label>
                <select id="scope">
                    <option value="schema">Schema</option>
                    <option value="table" selected>Table</option>
                    <option value="column">Column</option>
                </select>
            </div>
            <div class="search-input-wrap">
                <label>Search (matches on name only, shows full path)</label>
                <input type="text" id="searchInput" placeholder="Type to search... (e.g., stu, emp, email)">
                <div id="suggestions" class="suggestions"></div>
            </div>
        </div>
        
        <div class="config-row">
            <div>
                <label>Threshold (0-100)</label>
                <input type="number" id="threshold" value="50" min="0" max="100">
            </div>
            <div>
                <label>Max Results</label>
                <input type="number" id="limit" value="10" min="1" max="20">
            </div>
        </div>
        
        <div id="statusMsg" class="status-msg"></div>
    </div>

    <!-- Result -->
    <div id="result" class="result"></div>

    <script>
        const API = 'http://localhost:8000/api/v1';
        let env = 'dev';
        let debounceTimer;
        
        // Environment selection
        function selectEnv(e) {
            env = e;
            document.querySelectorAll('.env-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchInput').value = '';
            document.getElementById('suggestions').classList.remove('show');
            document.getElementById('statusMsg').textContent = '';
            document.getElementById('result').className = 'result';
        }
        
        // Search input
        const searchInput = document.getElementById('searchInput');
        const suggestionsEl = document.getElementById('suggestions');
        const statusMsg = document.getElementById('statusMsg');
        
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const q = e.target.value.trim();
            
            if (q.length < 2) {
                suggestionsEl.classList.remove('show');
                statusMsg.textContent = q.length === 1 ? 'Type one more character...' : '';
                return;
            }
            
            statusMsg.textContent = 'Searching...';
            debounceTimer = setTimeout(() => fetchSuggestions(q), 300);
        });
        
        async function fetchSuggestions(q) {
            const scope = document.getElementById('scope').value;
            const threshold = document.getElementById('threshold').value;
            const limit = document.getElementById('limit').value;
            
            try {
                const url = `${API}/suggest/with-scores?environment=${env}&scope=${scope}&q=${encodeURIComponent(q)}&threshold=${threshold}&limit=${limit}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length > 0) {
                    suggestionsEl.innerHTML = data.map(s => `
                        <div class="suggestion-item" onclick="selectItem('${s.name}')">
                            <span class="suggestion-name">${s.name}</span>
                            <span class="suggestion-score">${s.score}%</span>
                        </div>
                    `).join('');
                    suggestionsEl.classList.add('show');
                    statusMsg.textContent = `${data.length} result(s) in ${env.toUpperCase()} (threshold: ${threshold}%)`;
                } else {
                    suggestionsEl.classList.remove('show');
                    statusMsg.textContent = `No matches in ${env.toUpperCase()} above ${threshold}% threshold`;
                }
            } catch (err) {
                statusMsg.textContent = 'Error: ' + err.message;
            }
        }
        
        async function selectItem(name) {
            searchInput.value = name;
            suggestionsEl.classList.remove('show');
            statusMsg.textContent = 'Validating...';
            
            // Always validate before proceeding
            const scope = document.getElementById('scope').value;
            const parts = name.split('.');
            
            // Extract the actual name to validate based on scope
            let searchTerm, context = {};
            if (scope === 'schema') {
                searchTerm = name;
            } else if (scope === 'table') {
                searchTerm = parts.length > 1 ? parts[1] : name;
                if (parts.length > 1) context.schema_name = parts[0];
            } else {
                searchTerm = parts.length > 2 ? parts[2] : name;
                if (parts.length > 2) {
                    context.schema_name = parts[0];
                    context.table_name = parts[1];
                }
            }
            
            try {
                const res = await fetch(`${API}/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        environment: env,
                        scope: scope,
                        search_term: searchTerm,
                        context: Object.keys(context).length > 0 ? context : null
                    })
                });
                
                const data = await res.json();
                showResult(data, name);
                
            } catch (err) {
                statusMsg.textContent = 'Error: ' + err.message;
            }
        }
        
        function showResult(data, originalInput) {
            const resultEl = document.getElementById('result');
            resultEl.className = `result show ${data.status}`;
            
            let html = `<div class="result-header">
                <span class="status-badge ${data.status}">${data.status.toUpperCase()}</span>
                <span style="color:#888">${env.toUpperCase()}</span>
            </div>`;
            
            html += '<div class="result-text">';
            
            if (data.status === 'valid') {
                html += `Found: <code>${data.match}</code>`;
                html += `<div class="action-text go">→ Proceed to DB API</div>`;
                statusMsg.textContent = 'Valid! Ready to call DB.';
            } else if (data.status === 'suggestions') {
                html += `No exact match for <code>${originalInput}</code>. Did you mean:`;
                html += '<ul class="suggestion-list">';
                data.suggestions.forEach(s => {
                    html += `<li>${s.name} (${s.score}%)</li>`;
                });
                html += '</ul>';
                html += `<div class="action-text block">× DB call blocked</div>`;
                statusMsg.textContent = 'No exact match - select a suggestion.';
            } else {
                html += `<code>${originalInput}</code> not found in ${env.toUpperCase()}`;
                html += `<div class="action-text block">× DB call blocked</div>`;
                statusMsg.textContent = 'Not found.';
            }
            
            html += '</div>';
            resultEl.innerHTML = html;
        }
        
        // Hide suggestions on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-input-wrap')) {
                suggestionsEl.classList.remove('show');
            }
        });
        
        // Enter to validate manual input
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && searchInput.value.trim()) {
                selectItem(searchInput.value.trim());
            }
        });
        
        // Re-search when config changes
        document.getElementById('threshold').addEventListener('change', () => {
            const q = searchInput.value.trim();
            if (q.length >= 2) fetchSuggestions(q);
        });
        document.getElementById('limit').addEventListener('change', () => {
            const q = searchInput.value.trim();
            if (q.length >= 2) fetchSuggestions(q);
        });
    </script>
</body>
</html>
